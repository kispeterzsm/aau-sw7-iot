services:
  # --- Database ---
  db:
    image: postgres:16
    environment:
      POSTGRES_DB: linkcache
      POSTGRES_USER: app
      POSTGRES_PASSWORD: app
    ports: 
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U app -d linkcache"]
      interval: 3s
      timeout: 3s
      retries: 10
    volumes: 
      - pgdata:/var/lib/postgresql/data
    networks:
      - app-network

  # --- NLP Service ---
  nlp-service:
    build:
      context: ./nlp_module
      dockerfile: Dockerfile
      args:
        HF_TOKEN: ${HF_TOKEN}
    container_name: nlp-service
    ports: 
      - "8080:8080"
    environment:
      - HF_TOKEN=${HF_TOKEN}
      - MODEL_NAME=Qwen/Qwen3-4B-Instruct-2507
    restart: unless-stopped
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    networks:
      - app-network

  # --- Web Search Service ---
  web-search:
    build:
      context: ./web_search
      dockerfile: Dockerfile
    container_name: web-search
    ports: 
      - "8000:8000"
    environment:
      - NLP_SERVICE_URL=http://nlp-service:8080 
      - AUTH_TOKEN_NGROK=${AUTH_TOKEN_NGROK}
    depends_on:
      - nlp-service
    restart: unless-stopped
    networks:
      - app-network

  # --- Middleware API ---
  api:
    build: ./middleware
    container_name: middleware-api
    environment:
      # Server Config
      - SERVER_PORT=8999
      - SPRING_DATASOURCE_URL=jdbc:postgresql://db:5432/linkcache
      - SPRING_DATASOURCE_USERNAME=app
      - SPRING_DATASOURCE_PASSWORD=app
      - SPRING_DATASOURCE_DRIVER_CLASS_NAME=org.postgresql.Driver
      - SPRING_JPA_HIBERNATE_DDL_AUTO=update
      - DOWNSTREAM_BASE_URL=http://web-search:8000
      - DOWNSTREAM_LINK_PATH=/link/all
      - DOWNSTREAM_TEXT_PATH=/text/all

    ports: 
      - "8999:8999"
    restart: unless-stopped
    depends_on:
      db:
        condition: service_healthy
      web-search:
        condition: service_started
    networks:
      - app-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8999/health"]
      interval: 10s
      timeout: 3s
      retries: 5
      start_period: 20s

  # --- Emails ---
  email-service:
    build: ./email_service
    container_name: email-service
    ports:
      - "9000:9000"
    networks:
      - app-network
    depends_on:
      - maildev
    restart: unless-stopped

  maildev:
    image: maildev/maildev
    container_name: maildev
    ports:
      - "1080:1080"   # Web UI
      - "1025:1025"   # SMTP
    networks:
      - app-network
    restart: unless-stopped

  # --- 5. Frontend ---
  frontend:
    build: ./frontend
    container_name: frontend-app
    depends_on:
      api:
        condition: service_healthy
    environment:
      - NEXT_PUBLIC_API_URL=http://api:8999
    ports: 
      - "3000:3000"
    restart: unless-stopped
    networks:
      - app-network

volumes:
  pgdata:

networks:
  app-network:
    driver: bridge